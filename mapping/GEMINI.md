# `mapping` 模块说明

`mapping` 目录是 Otaku-Sync 项目的“数据规范化中心”。它包含了一系列 JSON 文件，其核心职责是解决来自不同数据源（DLsite, Fanza, Bangumi, GGBases）的数据在名称、分类和术语上的不一致问题，确保最终存入 Notion 的数据是统一、干净和标准化的。

## 1. 设计理念

- **配置驱动**: 绝大多数的数据转换规则都通过简单的 JSON 文件进行配置，而不是硬编码在代码中。这使得用户可以轻松地自定义和扩展映射规则，而无需修改程序逻辑。
- **渐进式维护**: 系统被设计为可以“边用边维护”。当程序遇到一个新的、未知的标签或属性时，它会通过交互界面（GUI或CLI）询问用户如何处理，并将用户的选择自动保存到对应的映射文件中，从而实现映射表的逐步完善。
- **分层映射**: 数据的规范化通过多个层次的映射文件协同完成，各司其职。

## 2. 核心文件概览

- **`映射文件说明.md`**: 提供 `mapping` 目录下各文件用途的中文说明。

- **`brand_mapping.json`**: 
    - **作用**: **品牌归一化**。这是为了解决同一个游戏制作公司在不同平台或时期使用不同名称的问题。
    - **示例**: `"YUZUSOFT": ["ゆずソフト", "YUZUSOFT", "YuzuSoft"]`。这意味着无论程序从哪个网站抓取到 “ゆずソフト” 或 “YuzuSoft”，它都会被识别并统一归类到 “YUZUSOFT” 这个标准品牌下。

- **`tag_jp_to_cn.json` / `tag_fanza_to_cn.json` / `tag_ggbase.json`**: 
    - **作用**: **原始标签翻译**。这些文件分别存储了从 DLsite、Fanza 和 GGBases 网站抓取到的原始标签到中文的翻译。
    - **维护**: 当程序遇到一个这些文件里没有记录的新标签时，它会通过 `InteractionProvider` 接口询问用户该如何翻译，然后将新的翻译对保存到对应的文件中。

- **`tag_mapping_dict.json`**: 
    - **作用**: **标签概念合并**。这是在标签翻译完成后的第二步处理。它用于将多个意义相近或属于同一范畴的中文标签合并为一个“主标签”。
    - **示例**: `"NTR/牛头人": ["NTR", "寝取られ"]`。这意味着，即使用户将日文 “NTR” 翻译为 “NTR”，将 “寝取られ” 翻译为 “寝取られ”，这个文件也能确保它们最终在 Notion 中都显示为统一的 `NTR/牛头人` 标签。

- **`bangumi_prop_mapping.json`**: 
    - **作用**: **Bangumi 属性映射**。用于将从 Bangumi API 获取的字段名（Key）映射到 Notion 数据库中对应的属性名。
    - **示例**: 在 `games` 命名空间下，`"发售日": ["発売日"]` 表示 Bangumi 的 “発売日” 字段应写入 Notion 游戏数据库的 “发售日” 属性中。
    - **动态处理**: 这是唯一一个完全由程序在运行时通过与用户交互来动态维护的映射文件。当遇到新的 Bangumi 字段时，`BangumiMappingManager` 会询问用户是将其映射到现有属性，还是在 Notion 中创建一个新属性。

- **`genre_mapping.json`**: 
    - **作用**: **游戏类型映射**。用于将不同来源的类型（genre）映射为统一的格式。

- **`name_split_exceptions.json`**: 
    - **作用**: **名称拆分例外**。用于处理特殊的游戏名称，避免 `name_splitter.py` 错误地拆分品牌和标题。

- **`tag_replace_map.py`**: 
    - **作用**: **标签替换规则**。定义了在 `scripts/replace_and_clean_tags.py` 脚本中使用的标签替换规则。

- **`bangumi_ignore_list.json` / `tag_ignore_list.json`**: 
    - **作用**: **忽略列表**。分别用于记录那些应该被程序永久忽略的 Bangumi 属性（例如，无意义的 “开发”、“发行” 等字段）和原始标签（例如，DLsite上与促销活动相关的临时标签）。

## 3. 工作流程

以标签处理为例，其完整的规范化流程如下：

1.  从 DLsite 抓取到一个日文标签，例如 “巨乳”。
2.  程序查询 `tag_jp_to_cn.json`，发现没有 “巨乳” 的翻译。
3.  程序通过交互界面询问用户：“新标签 ‘巨乳’ 如何翻译？”
4.  用户输入 “巨乳”。程序将 `{"巨乳": "巨乳"}` 保存到 `tag_jp_to_cn.json`。
5.  程序得到中文标签 “巨乳”。
6.  程序查询 `tag_mapping_dict.json`，发现 “巨乳” 属于 `"巨乳/爆乳": ["巨乳", "爆乳"]` 这个合并规则的一部分。
7.  最终，程序确定该标签应被记为 “巨乳/爆乳”。
8.  在同步到 Notion 时，如果 “巨乳/爆乳” 这个选项在多选属性中不存在，程序会自动创建它。