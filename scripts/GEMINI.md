# `scripts` 模块说明 (已完善)

`scripts` 目录包含了一系列独立的、可执行的 Python 脚本，主要用于执行数据维护、批量处理、数据导出和修复等一次性或周期性的任务。这些脚本通常会直接与 `core` 或 `clients` 模块交互，以完成特定功能。

## 1. 设计理念

- **任务导向**: 每个脚本都为了解决一个特定的维护问题而存在。
- **可独立运行**: 大多数脚本都包含一个 `if __name__ == "__main__":` 块，使其可以作为独立的程序直接从命令行运行（例如 `python scripts/your_script.py`）。它们会自行初始化所需的应用上下文。
- **GUI 集成**: 部分常用的、对用户友好的脚本通过 `gui/widgets.py` 中的 `BatchToolsWidget` 集成到了图形界面中，用户只需点击按钮即可执行。

## 2. 核心脚本功能详解

- **`fill_missing_bangumi.py`**: 
    - **功能**: 遍历 Notion 游戏数据库，筛选出所有“Bangumi链接”字段为空的条目。对每个条目，使用其游戏标题在 Bangumi 进行搜索和匹配。如果找到匹配项，则调用 `bangumi_client.create_or_link_characters` 方法，这不仅会填充 Bangumi 链接，还会抓取并关联所有相关的角色信息。
    - **交互**: 在命令行模式下，如果自动匹配不确定，会提示用户从候选列表中手动选择。

- **`fill_missing_character_fields.py`**: 
    - **功能**: 遍历 Notion 角色数据库，检查每个角色条目是否缺少关键信息（如BWH、身高、生日、血型、性别）。如果缺少，则从该角色已有的“详情页面”（Bangumi角色URL）中提取ID，重新从 Bangumi API 获取完整的角色信息，并更新到 Notion 页面中。

- **`auto_tag_completer.py`**: 
    - **功能**: 查找 Notion 游戏库中“标签”字段为空的游戏。对于每个这样的游戏，它会尝试从其“DLsite链接”或“GGBases资源”链接中重新抓取原始标签，然后调用 `TagManager` 进行翻译和规范化，最后将补全的标签更新回 Notion。

- **`update_brand_latestBeat.py`**: 
    - **功能**: 一个复合统计脚本。它首先遍历所有游戏，计算出每个品牌的“最近通关作品”，以及全局的“最新通关游戏”和“最新发售游戏”。然后，它会更新 Notion 中每个品牌页面的对应字段，并更新一个专门的“通关统计”总览页面。
    - **缓存**: 该脚本使用本地JSON缓存 (`cache/brand_latest_cache.json`) 来避免重复更新没有变化的品牌页面。

- **`update_Brand_Info.py`**: 
    - **功能**: 遍历 Notion 中的**每一个**品牌，使用其名称去 Bangumi 搜索，并拉取最新的信息（如简介、官网、社交链接等）来更新 Notion 中对应的品牌页面。这是一个全量更新脚本。

- **`replace_and_clean_tags.py`**: 
    - **功能**: 标签系统维护工具。它首先根据 `mapping/tag_replace_map.py` 中的规则，批量替换所有游戏页面中的旧标签。完成替换后，它会统计所有“在用”的标签，并与数据库中定义的全部标签选项进行对比，最后生成一个 `unused_tags.txt` 报告，列出所有已无人使用、可以被安全删除的标签。
    - **模式**: 支持 `dry_run` 模式，可以只报告将要发生的变更而不实际执行。

- **`export_all_tags.py` / `export_brand_names.py`**: 
    - **功能**: 数据导出工具。分别用于从 Notion 数据库中提取所有唯一的标签或品牌名，并将其保存为 `all_tags.txt` 或 `brand_names.txt` 文件。

- **`extract_brands.py`**: 
    - **功能**: 从游戏标题中提取品牌名称，并将其填充到“品牌”字段中。

- **`inspect_notion_fields.py`**: 
    - **功能**: 交互式诊断工具。它会列出在 `config/config_token.py` 中配置的所有数据库，让用户选择一个。然后，它会连接到该数据库，并打印出其所有的字段名称和类型。这对于用户排查“字段名不匹配”的配置问题非常有用。

## 3. 如何使用

- **GUI**: 对于已集成的脚本，直接在主界面的“批处理工具”区域点击对应按钮即可。
- **命令行**: 对于未集成或需要更复杂参数的脚本，可以通过命令行直接运行。在运行前，请确保 `.env` 文件已正确配置。