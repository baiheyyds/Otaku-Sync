# `utils` 模块说明

`utils` 目录提供了一系列在项目中被广泛复用的、与核心业务逻辑无关的通用工具和辅助功能。这些模块旨在提高代码的复用性、可维护性和整洁性。

## 1. 设计理念

- **通用性与独立性**: `utils` 中的模块应该是通用的，不应依赖于 `core` 或 `gui` 中的特定业务逻辑。例如，`logger.py` 可以在任何需要控制台输出的地方使用。
- **功能单一**: 每个工具模块都聚焦于解决一个特定的问题。例如，`driver.py` 只负责创建和配置 Selenium WebDriver，`tag_manager.py` 只负责处理标签的逻辑。

## 2. 核心文件概览

- **`logger.py`**: 
    - **作用**: 提供一个简单的、带颜色和图标的控制台日志记录器。
    - **功能**: 定义了 `step`, `info`, `success`, `warn`, `error` 等不同级别的日志函数，使得在命令行模式下输出的信息更加结构化和美观。在 GUI 模式下，这些函数会被 `gui_bridge.py` 中的 `patch_logger` 动态替换，使其输出内容重定向到图形界面的日志窗口。

- **`driver.py`**: 
    - **作用**: 封装了创建和配置 Selenium WebDriver 的复杂过程。
    - **核心函数**: `create_driver()`，它负责：
        - 使用 `webdriver-manager` 自动下载和管理 ChromeDriver。
        - 设置一系列 Chrome 选项以实现无头运行、禁用日志、反爬虫检测等。
        - 在 Windows 上隐藏弹出的 `cmd` 窗口。

- **`tag_manager.py` (`TagManager`)**: 
    - **作用**: 一个高度集中的标签处理中心，封装了所有与标签相关的复杂逻辑，包括翻译、合并和持久化。
    - **核心流程**: 它的 `process_tags` 方法接收来自不同来源的原始标签列表，然后执行一个完整的处理流水线：
        1.  **翻译**: 对来自 DLsite 和 Fanza 的日文标签，查询翻译映射表。如果遇到新标签，则通过 `InteractionProvider` 接口询问用户并保存新翻译。
        2.  **合并**: 对所有翻译后的中文标签，查询 `tag_mapping_dict.json`，将同义词（如“巨乳”、“爆乳”）合并为一个主标签（如“巨乳/爆乳”）。
        3.  **学习**: 如果遇到一个全新的中文概念，它会再次通过 `InteractionProvider` 询问用户是否要将其合并到某个现有的标签组中，并将用户的选择学习并保存下来。
    - **持久化**: `TagManager` 实例在内存中维护所有标签映射，并提供了 `save_all_maps` 方法，在程序退出时将所有更改写回 `mapping/` 目录下的 JSON 文件中。

- **`utils.py`**: 
    - **作用**: 一个通用的函数集合，用于存放一些零散但有用的工具函数。
    - **核心函数**: 
        - `normalize_brand_name()`: 将品牌名称进行标准化处理（转小写、移除特殊符号等），便于进行不区分大小写和格式的比较。
        - `convert_date_jp_to_iso()`: 将日文格式的日期（如 `2023年10月26日`）或其它常见格式转换为标准的 ISO 格式（`2023-10-26`），以便存入 Notion 的 Date 类型属性。

- **`gui_bridge.py`**: 
    - **作用**: 作为 GUI 与后台逻辑的桥梁，虽然位于 `utils` 目录，但其功能与 `gui` 模块紧密相关。详细说明请参见 `gui/GEMINI.md`。

- **`similarity_check.py`**: 
    - **作用**: 提供了检查 Notion 中是否存在与给定标题相似的游戏的功能，用于避免重复创建条目。